require 'spec_helper'
require 'fpm/cookery/facts'

describe "Facts" do
  before do
    FPM::Cookery::Facts.reset!
  end

  describe "arch" do
    it "returns the current architecture as a symbol" do
      expect(FPM::Cookery::Facts.arch).to be_a(Symbol)
    end

    it "returns a valid architecture" do
      expect(FPM::Cookery::Facts.arch).to_not be_nil
    end
  end

  describe "platform" do
    context "with /etc/os-release" do
      before do
        allow(File).to receive(:exist?).and_call_original
        allow(File).to receive(:exist?).with('/etc/os-release').and_return(true)
        allow(File).to receive(:readlines).with('/etc/os-release').and_return([
          'ID=ubuntu',
          'VERSION_ID="22.04"',
          'VERSION_CODENAME=jammy'
        ])
      end

      it "detects platform from os-release ID" do
        expect(FPM::Cookery::Facts.platform).to eq(:ubuntu)
      end
    end

    context "with CentOS in /etc/os-release" do
      before do
        allow(File).to receive(:exist?).and_call_original
        allow(File).to receive(:exist?).with('/etc/os-release').and_return(true)
        allow(File).to receive(:readlines).with('/etc/os-release').and_return([
          'ID="centos"',
          'VERSION_ID="7"'
        ])
      end

      it "detects CentOS platform" do
        expect(FPM::Cookery::Facts.platform).to eq(:centos)
      end
    end

    it "can be set" do
      FPM::Cookery::Facts.platform = 'CentOS'
      expect(FPM::Cookery::Facts.platform).to eq(:centos)
    end
  end

  describe "osrelease" do
    context "with /etc/os-release" do
      before do
        allow(File).to receive(:exist?).and_call_original
        allow(File).to receive(:exist?).with('/etc/os-release').and_return(true)
        allow(File).to receive(:readlines).with('/etc/os-release').and_return([
          'ID=centos',
          'VERSION_ID="6.5"'
        ])
      end

      it "returns the operating system release version" do
        expect(FPM::Cookery::Facts.osrelease).to eq('6.5')
      end
    end
  end

  describe "osmajorrelease" do
    context "with /etc/os-release" do
      before do
        allow(File).to receive(:exist?).and_call_original
        allow(File).to receive(:exist?).with('/etc/os-release').and_return(true)
        allow(File).to receive(:readlines).with('/etc/os-release').and_return([
          'ID=centos',
          'VERSION_ID="6.5"'
        ])
      end

      it "returns the operating system major release version" do
        expect(FPM::Cookery::Facts.osmajorrelease).to eq('6')
      end
    end
  end

  describe "osfamily" do
    context "with ID_LIKE in os-release" do
      before do
        allow(File).to receive(:exist?).and_call_original
        allow(File).to receive(:exist?).with('/etc/os-release').and_return(true)
        allow(File).to receive(:readlines).with('/etc/os-release').and_return([
          'ID=ubuntu',
          'ID_LIKE=debian'
        ])
      end

      it "detects osfamily from ID_LIKE" do
        expect(FPM::Cookery::Facts.osfamily).to eq(:debian)
      end
    end

    context "with RedHat-like in os-release" do
      before do
        allow(File).to receive(:exist?).and_call_original
        allow(File).to receive(:exist?).with('/etc/os-release').and_return(true)
        allow(File).to receive(:readlines).with('/etc/os-release').and_return([
          'ID=rocky',
          'ID_LIKE="rhel centos fedora"'
        ])
      end

      it "detects osfamily as redhat" do
        expect(FPM::Cookery::Facts.osfamily).to eq(:redhat)
      end
    end

    it "can be set" do
      FPM::Cookery::Facts.osfamily = 'RedHat'
      expect(FPM::Cookery::Facts.osfamily).to eq(:redhat)
    end
  end

  describe "lsbcodename" do
    context "with VERSION_CODENAME in os-release" do
      before do
        allow(File).to receive(:exist?).and_call_original
        allow(File).to receive(:exist?).with('/etc/os-release').and_return(true)
        allow(File).to receive(:readlines).with('/etc/os-release').and_return([
          'ID=ubuntu',
          'VERSION_CODENAME=trusty'
        ])
      end

      it "returns the codename" do
        expect(FPM::Cookery::Facts.lsbcodename).to eq(:trusty)
      end
    end

    context "with UBUNTU_CODENAME in os-release" do
      before do
        allow(File).to receive(:exist?).and_call_original
        allow(File).to receive(:exist?).with('/etc/os-release').and_return(true)
        allow(File).to receive(:readlines).with('/etc/os-release').and_return([
          'ID=linuxmint',
          'UBUNTU_CODENAME=focal'
        ])
      end

      it "returns the Ubuntu codename" do
        expect(FPM::Cookery::Facts.lsbcodename).to eq(:focal)
      end
    end
  end

  describe "target" do
    describe "with os family RedHat" do
      it "returns rpm" do
        FPM::Cookery::Facts.osfamily = 'RedHat'
        expect(FPM::Cookery::Facts.target).to eq(:rpm)
      end
    end

    describe "with os family Suse" do
      it "returns rpm" do
        FPM::Cookery::Facts.osfamily = 'Suse'
        expect(FPM::Cookery::Facts.target).to eq(:rpm)
      end
    end

    describe "with os family Debian" do
      it "returns deb" do
        FPM::Cookery::Facts.osfamily = 'Debian'
        expect(FPM::Cookery::Facts.target).to eq(:deb)
      end
    end

    describe "with os family Darwin" do
      it "returns osxpkg" do
        FPM::Cookery::Facts.osfamily = 'Darwin'
        expect(FPM::Cookery::Facts.target).to eq(:osxpkg)
      end
    end

    describe "with os family Alpine" do
      it "returns apk" do
        FPM::Cookery::Facts.osfamily = 'Alpine'
        expect(FPM::Cookery::Facts.target).to eq(:apk)
      end
    end

    describe "with an unknown os family" do
      it "returns nil" do
        FPM::Cookery::Facts.osfamily = '___X___'
        expect(FPM::Cookery::Facts.target).to eq(nil)
      end
    end

    it "can be set" do
      FPM::Cookery::Facts.target = 'rpm'
      expect(FPM::Cookery::Facts.target).to eq(:rpm)
    end
  end

  describe "parse_os_release" do
    before do
      allow(File).to receive(:exist?).and_call_original
      allow(File).to receive(:exist?).with('/etc/os-release').and_return(true)
    end

    it "handles quoted values" do
      allow(File).to receive(:readlines).with('/etc/os-release').and_return([
        'ID="ubuntu"',
        "NAME='Ubuntu'",
        'VERSION_ID="22.04"'
      ])

      expect(FPM::Cookery::Facts.platform).to eq(:ubuntu)
      expect(FPM::Cookery::Facts.osrelease).to eq('22.04')
    end

    it "handles unquoted values" do
      allow(File).to receive(:readlines).with('/etc/os-release').and_return([
        'ID=alpine',
        'VERSION_ID=3.18.0'
      ])

      expect(FPM::Cookery::Facts.platform).to eq(:alpine)
      expect(FPM::Cookery::Facts.osrelease).to eq('3.18.0')
    end

    it "skips comments and empty lines" do
      allow(File).to receive(:readlines).with('/etc/os-release').and_return([
        '# This is a comment',
        '',
        'ID=debian',
        '   ',
        'VERSION_ID="12"'
      ])

      expect(FPM::Cookery::Facts.platform).to eq(:debian)
    end
  end

  describe "platform to osfamily mapping" do
    before do
      allow(File).to receive(:exist?).and_call_original
      allow(File).to receive(:exist?).with('/etc/os-release').and_return(true)
    end

    {
      'ubuntu' => :debian,
      'debian' => :debian,
      'linuxmint' => :debian,
      'centos' => :redhat,
      'fedora' => :redhat,
      'rocky' => :redhat,
      'almalinux' => :redhat,
      'opensuse' => :suse,
      'alpine' => :alpine,
      'arch' => :archlinux
    }.each do |platform, expected_family|
      it "maps #{platform} to #{expected_family}" do
        allow(File).to receive(:readlines).with('/etc/os-release').and_return([
          "ID=#{platform}"
        ])
        FPM::Cookery::Facts.reset!
        expect(FPM::Cookery::Facts.osfamily).to eq(expected_family)
      end
    end
  end
end
